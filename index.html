
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סקראץ' בלוקלי</title>
    <link rel="stylesheet" href="index.css">
    <!-- Load Blockly from CDN -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript.min.js"></script>
    <script src="https://unpkg.com/blockly/msg/he.js"></script>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.12.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="app">
        <div id="editor-area">
            <div id="ai-controls-container">
                <button id="save-project-button" class="header-button" title="שמור פרויקט" aria-label="שמור פרויקט">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                </button>
                <button id="load-project-button" class="header-button" title="טען פרויקט" aria-label="טען פרויקט">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                </button>
                <input type="file" id="load-project-input" accept=".json" hidden>
                <button id="ai-script-button" class="header-button">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M15 19.88c.04.34.28.62.62.62s.58-.28.62-.62l.4-3.38c.6-.22 1.15-.54 1.66-.94l3.22 1.2c.33.12.7-.04.82-.38.12-.33-.04-.7-.38-.82l-3.22-1.2c.4-.5.72-1.06.94-1.66l3.38-.4c.34-.04.62-.28.62-.62s-.28-.58-.62-.62l-3.38-.4c-.22-.6-.54-1.15-.94-1.66l3.22-1.2c.33-.12.45-.5.33-.82-.13-.34-.5-.45-.82-.33l-3.22 1.2c-.5-.4-1.06-.72-1.66-.94l.4-3.38c.04-.34-.28-.62-.62-.62s-.58.28-.62-.62l-.4 3.38c-.6.22-1.15-.54-1.66-.94l-3.22-1.2c-.33-.12-.7.04-.82.38-.12-.33.04.7.38.82l3.22 1.2c-.4.5-.72-1.06-.94 1.66l-3.38.4c-.34.04-.62.28.62-.62s.28.58.62.62l3.38.4c.22.6.54 1.15.94 1.66l-3.22 1.2c-.33-.12-.45.5-.33.82.13.34.5.45.82.33l3.22-1.2c.5.4 1.06.72 1.66.94l-.4 3.38zM12 15c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3z"/></svg>
                    <span>צור תסריטים באמצעות AI</span>
                </button>
            </div>
            <div id="blockly-container"></div>
        </div>
        <div id="right-panel">
            <div id="stage-area">
                <div id="stage-header">
                    <h3>במה</h3>
                    <div id="controls">
                        <button id="go-button" aria-label="הפעל">
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="#4CAF50"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
                        </button>
                        <button id="stop-button" aria-label="עצור">
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="#F44336" stroke="white" stroke-width="1"><rect x="6" y="6" width="12" height="12"/></svg>
                        </button>
                        <button id="fullscreen-button" aria-label="מסך מלא">
                            <svg class="enter-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#5f6368"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                            <svg class="exit-fullscreen-icon" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#5f6368"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
                        </button>
                    </div>
                </div>
                <div id="stage">
                    <div id="sprite-container">
                        <!-- Sprites will be dynamically added here -->
                    </div>
                    <div id="speech-bubble-container">
                        <!-- Speech bubbles will be dynamically added here -->
                    </div>
                    <div id="color-picker-overlay" class="hidden"></div>
                </div>
            </div>

            <!-- New Vertically Stacked Panels Container -->
            <div id="panels-container">
                <div id="properties-panel">
                    <div class="panel-header">
                       <h4>מאפיינים</h4>
                    </div>
                    <div class="prop-grid">
                       <label for="sprite-name-input">שם:</label>
                       <input type="text" id="sprite-name-input">

                       <label for="sprite-x-slider">ציר X:</label>
                       <div class="slider-group">
                           <input type="range" id="sprite-x-slider" min="-240" max="240" value="0">
                           <input type="number" id="sprite-x-num" class="num-input">
                       </div>
               
                       <label for="sprite-y-slider">ציר Y:</label>
                       <div class="slider-group">
                           <input type="range" id="sprite-y-slider" min="-180" max="180" value="0">
                           <input type="number" id="sprite-y-num" class="num-input">
                       </div>
               
                       <label for="sprite-size-slider">גודל:</label>
                       <div class="slider-group">
                           <input type="range" id="sprite-size-slider" min="10" max="350" value="100">
                           <input type="number" id="sprite-size-num" class="num-input">
                       </div>

                       <label for="sprite-hue-slider">גוון:</label>
                       <div class="slider-group">
                           <input type="range" id="sprite-hue-slider" min="0" max="360" value="0">
                           <input type="number" id="sprite-hue-num" class="num-input">
                       </div>
                    </div>
                    
                    <div class="prop-separator"></div>

                    <div class="prop-row">
                        <div class="prop-group">
                            <label>כיוון</label>
                            <div class="direction-group">
                                <div id="direction-dial">
                                    <div id="direction-dial-handle-pivot">
                                        <div id="direction-dial-handle"></div>
                                    </div>
                                    <span class="prop-dial-label prop-dial-label-0">0</span>
                                    <span class="prop-dial-label prop-dial-label-90">90</span>
                                    <span class="prop-dial-label prop-dial-label-180">180</span>
                                    <span class="prop-dial-label prop-dial-label-270">270</span>
                                </div>
                                <div class="direction-input-group">
                                    <input type="number" id="sprite-direction-num" class="num-input" min="0" max="360" value="90">
                                    <div class="direction-steppers">
                                        <button id="direction-step-up" class="stepper-arrow" title="הגדל כיוון">▲</button>
                                        <button id="direction-step-down" class="stepper-arrow" title="הקטן כיוון">▼</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="prop-group">
                            <label>סיבוב</label>
                            <div id="rotation-style-controls">
                                <button class="rotation-style-btn" data-style="all-around" title="סיבוב מלא">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                </button>
                                <button class="rotation-style-btn" data-style="left-right" title="שמאל-ימין">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
                                </button>
                                <button class="rotation-style-btn" data-style="none" title="ללא סיבוב">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zM4.93 4.93l14.14 14.14-1.41 1.41-14.14-14.14 1.41-1.41z"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div class="prop-group">
                            <label>הצג</label>
                            <input type="checkbox" id="sprite-show-checkbox" checked>
                        </div>
                    </div>
                </div>

                <div id="sprite-panel">
                    <div id="sprite-panel-header" class="panel-header">
                        <h4>דמויות</h4>
                        <button id="add-sprite-button" aria-label="הוסף דמות">+</button>
                    </div>
                    <div id="sprite-list">
                        <!-- Sprite info blocks will be dynamically added here -->
                    </div>
                </div>
                
                <div id="sounds-panel">
                    <div id="sounds-panel-header" class="panel-header">
                        <h4>צלילים</h4>
                        <div class="panel-header-buttons">
                            <button id="add-sound-record-button" class="panel-action-button" aria-label="הקלט צליל" title="הקלט צליל">
                                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
                            </button>
                            <button id="add-sound-button" class="panel-action-button" aria-label="הוסף צליל מהספרייה" title="הוסף צליל מהספרייה">+</button>
                        </div>
                    </div>
                    <div id="sound-list">
                        <!-- Sound items will be a dynamically added here -->
                    </div>
                </div>

                <div id="backdrop-panel">
                    <div id="backdrop-panel-header" class="panel-header">
                        <h4>רקעים</h4>
                        <button id="add-backdrop-button" aria-label="הוסף רקע">+</button>
                    </div>
                    <div id="backdrop-thumbnail-list">
                        <!-- Backdrop thumbnails will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sprite Library Modal -->
    <div id="sprite-library-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>בחר דמות</h3>
                <button id="close-library-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-upload-section">
                <button id="upload-sprite-button">העלה דמות</button>
                <button id="ai-create-sprite-button">צור דמות עם AI</button>
                <input type="file" id="upload-sprite-input" accept="image/png, image/jpeg, image/svg+xml, image/gif" hidden>
            </div>
            <div id="sprite-grid" class="modal-body">
                <!-- Sprite options will be injected here by JS -->
            </div>
        </div>
    </div>
    
    <!-- Backdrop Library Modal -->
    <div id="backdrop-library-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>בחר רקע</h3>
                <button id="close-backdrop-library-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-upload-section">
                <button id="upload-backdrop-button">העלה רקע</button>
                <input type="file" id="upload-backdrop-input" accept="image/png, image/jpeg, image/svg+xml" hidden>
            </div>
            <div id="backdrop-grid" class="modal-body">
                <!-- Backdrop options will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- Sound Library Modal -->
    <div id="sound-library-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>בחר צליל</h3>
                <button id="close-sound-library-button" aria-label="סגור">&times;</button>
            </div>
            <div id="sound-grid" class="modal-body">
                <!-- Sound options will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- Sound Recorder Modal -->
    <div id="sound-recorder-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>הקלטת צליל חדש</h3>
                <button id="close-recorder-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-body" id="recorder-body">
                <!-- Initial View -->
                <div id="recorder-initial-view">
                    <p>לחץ על המיקרופון כדי להתחיל להקליט</p>
                    <button id="record-button" class="recorder-control-main" aria-label="התחל הקלטה">
                        <svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 0 24 24" width="48"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
                    </button>
                </div>
                <!-- Recording View -->
                <div id="recorder-recording-view" class="hidden">
                    <canvas id="recorder-visualizer" width="300" height="100"></canvas>
                    <div id="recorder-timer">00:00</div>
                    <button id="stop-record-button" class="recorder-control-main recording" aria-label="עצור הקלטה">
                        <svg xmlns="http://www.w3.org/2000/svg" height="36" viewBox="0 0 24 24" width="36"><path d="M6 6h12v12H6z"/></svg>
                    </button>
                </div>
                <!-- Review View -->
                <div id="recorder-review-view" class="hidden">
                    <div class="recorder-review-controls">
                        <button id="play-recording-button" class="review-button" aria-label="נגן">
                            <svg id="recording-playback-icon" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <input type="text" id="recording-name-input" placeholder="שם ההקלטה">
                    </div>
                     <div class="recorder-review-actions">
                        <button id="rerecord-button" class="review-button">הקלט מחדש</button>
                        <button id="save-recording-button" class="review-button save" disabled>שמור</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Scripting Modal -->
    <div id="ai-script-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>צור תסריטים באמצעות AI</h3>
                <button id="close-ai-modal-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-body">
                <p class="ai-modal-description">תאר מה תרצה שהדמות תעשה. לדוגמה: "זוז במעגל, אמור שלום, והגדל את עצמך".</p>
                <textarea id="ai-prompt-textarea" placeholder="לדוגמה: קפוץ 3 פעמים..." rows="4"></textarea>
                <div id="ai-modal-footer">
                    <div id="ai-spinner" class="spinner hidden"></div>
                    <button id="generate-script-button" class="num-pad-btn">צור תסריט</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GIF Editor Modal -->
    <div id="gif-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>עורך אנימציית GIF</h3>
                <button id="close-gif-editor-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div id="gif-editor-preview-container">
                    <div id="gif-editor-spinner" class="spinner hidden"></div>
                    <canvas id="gif-preview-canvas" class="hidden"></canvas>
                </div>
                <div class="gif-editor-controls">
                    <label for="gif-speed-slider">מהירות:</label>
                    <input type="range" id="gif-speed-slider" min="0.25" max="4" step="0.05" value="1" style="direction: ltr;">
                    <span id="gif-speed-value">1.00x</span>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Sprite Generator Modal -->
    <div id="ai-sprite-generator-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>יצירת דמות באמצעות AI</h3>
                <button id="close-ai-generator-button" aria-label="סגור">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px;">
                <p class="ai-modal-description">תאר את הדמות שברצונך ליצור בסגנון קליפ-ארט. לדוגמה: "רובוט ידידותי בצבע כחול מחזיק פרח".</p>
                <textarea id="ai-sprite-prompt-textarea" placeholder="לדוגמה: דרקון סגול קטן ומחייך..." rows="3"></textarea>
                <div id="ai-sprite-preview-container">
                    <div id="ai-sprite-generator-spinner" class="spinner hidden"></div>
                    <img id="ai-sprite-preview-image" class="hidden" alt="תצוגה מקדימה של הדמות שנוצרה">
                </div>
                <div id="ai-sprite-generator-footer">
                    <button id="add-generated-sprite-button" disabled title="הוסף לפרויקט" aria-label="הוסף לפרויקט">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </button>
                    <button id="remove-background-button" class="secondary-action-button" disabled title="הסר רקע" aria-label="הסר רקע">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M20 4h-4.32l-3.23 4.54 1.41 1.41L17 6h3v2l-1.55 1.55-1.41 1.41L20 13.52V18h-4.32l-3.23-4.54-1.41-1.41L8 16H5v-2l1.55-1.55 1.41-1.41L5 8.48V4h4.32l3.23 4.54 1.41 1.41L17 4z"/></svg>
                    </button>
                    <button id="generate-sprite-button" title="צור דמות" aria-label="צור דמות">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37c-.39-.39-1.02-.39-1.41 0L14 10.01V3c0-.55-.45-1-1-1s-1 .45-1 1v7.01l-5.41 5.41c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l7.8-7.81 2.92-2.91c.39-.39.39-1.02 0-1.42z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Number Pad -->
    <div id="number-pad-modal" class="hidden">
        <div id="number-pad-display">0</div>
        <div id="number-pad-grid">
            <button class="num-pad-btn" data-value="7">7</button>
            <button class="num-pad-btn" data-value="8">8</button>
            <button class="num-pad-btn" data-value="9">9</button>
            <button class="num-pad-btn" data-value="4">4</button>
            <button class="num-pad-btn" data-value="5">5</button>
            <button class="num-pad-btn" data-value="6">6</button>
            <button class="num-pad-btn" data-value="1">1</button>
            <button class="num-pad-btn" data-value="2">2</button>
            <button class="num-pad-btn" data-value="3">3</button>
            <button class="num-pad-btn" id="num-pad-sign">+/-</button>
            <button class="num-pad-btn" data-value="0">0</button>
            <button class="num-pad-btn" data-value=".">.</button>
            <button class="num-pad-btn" id="num-pad-backspace" aria-label="מחק"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M21 11H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21v-2z"/></svg></button>
            <button class="num-pad-btn" id="num-pad-clear">נקה</button>
        </div>
        <button class="num-pad-btn" id="num-pad-ok">אישור</button>
    </div>
    <div id="numpad-backdrop" class="hidden"></div>
    
    <!-- Direction Editor Popover -->
    <div id="direction-editor-popover" class="hidden">
        <div id="direction-editor-display">90</div>
        <div class="direction-editor-controls">
            <div id="direction-editor-dial">
                <div id="direction-editor-dial-handle"></div>
                <span class="dial-label dial-label-n">N</span>
                <span class="dial-label dial-label-e">E</span>
                <span class="dial-label dial-label-s">S</span>
                <span class="dial-label dial-label-w">W</span>
            </div>
            <div class="direction-editor-stepper">
                <button id="direction-editor-up" class="stepper-arrow">▲</button>
                <button id="direction-editor-down" class="stepper-arrow">▼</button>
            </div>
        </div>
        <button id="direction-editor-ok">אישור</button>
    </div>
    <div id="direction-editor-backdrop" class="hidden"></div>

    <!-- Color Picker Elements -->
    <div id="color-palette-popover" class="hidden">
        <button id="color-palette-eyedropper" aria-label="בחר צבע מהבמה" title="בחר צבע מהבמה">
            <img src="https://codejredu.github.io/test/assets/blocklyicon/colorpicker.svg" width="24" height="24" alt="בחר צבע מהבמה">
        </button>
        <div id="color-palette-grid">
            <!-- Color swatches are generated here by JS -->
        </div>
    </div>
    <div id="color-palette-backdrop" class="hidden"></div>
    <div id="color-picker-magnifier" class="hidden">
        <canvas></canvas>
    </div>

    <script type="module" src="index.js"></script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
